#!/bin/bash
set -uo pipefail
IFS=$'\n\t'

# Defines some global variables for colors.
normal=$(tput sgr0)
red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)

function main() {
    help_msg="Usage: bash ./bin/functions.sh <command>
    Available commands:
        install_wp_cli: Installs WP-CLI."
    valid_commands=("install_wp_cli")

    if [ -z "$1" ]; then
        echo "${red}No command specified.${normal}"
        echo "${help_msg}"
        exit 1;
    fi

    if [ "$1" == "help" ]; then
        echo "${help_msg}"
        exit 0;
    fi

    # Check for a valid command.
    if [ ! " ${function_names[@]} " =~ " $1 " ]; then
        echo "${red}Invalid command specified.${normal}"
        echo "${help_msg}"
        exit 1;
    fi

    # Execute the command passed.
    "$1"
}

function install_wp_cli() {
    cd /tmp/wordpress
    curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    chmod +x wp-cli.phar
    sudo mv wp-cli.phar /usr/local/bin/wp
}

function install_wp() {
    cd /tmp/wordpress
    wp config create --dbname=wordpress --dbuser=root --dbpass=root --dbhost=127.0.0.1
    wp core install --url=wpvulnerability.test --title=WordPress --admin_user=progressbar --admin_password=password --admin_email=noreply@dev.null
}

function setup_vuln_scanner() {
    package_install_directory="/tmp/wordpress/wp-content/${{ inputs.type }}s/${{ inputs.name }}"
    cd /tmp/wordpress
    if [[ ${{ inputs.type }} == "plugin" ]]; then
        wp plugin delete hello
        wp plugin delete akismet
    elif [[ ${{ inputs.type }} == "theme" ]]; then
        rm -rf wp-content/themes/twenty*
    fi
    rm wp-content/db.php
    mkdir -p ${package_install_directory}
    echo "Checking if ${{ inputs.name }} exists in ${package_install_directory}..."
    if [[ -d ${package_install_directory} ]]; then
        echo "✅ ${green}Directory exists!${normal}"
    else
        echo "❌ ${red}Directory does not exist!${normal}"
    exit 1
    fi
    echo "${yellow}Copying ${{ inputs.name }} from ${GITHUB_WORKSPACE} to ${package_install_directory}${normal}"
    cp -r ${GITHUB_WORKSPACE}/${{ inputs.name }}/* ${package_install_directory}
    wp ${{ inputs.type }} list
    wp ${{ inputs.type }} activate "${{ inputs.name }}"
    wp package install 10up/wpcli-vulnerability-scanner:dev-trunk
    wp config set VULN_API_PROVIDER ${{ inputs.api-provider }}
    wp config set VULN_API_TOKEN "${{ inputs.api-token }}"
}

main "$@"