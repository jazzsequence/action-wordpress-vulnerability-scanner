#!/bin/bash
set -uo pipefail
IFS=$'\n\t'

function main() {
    help_msg="Usage: bash ./bin/functions.sh <command>
    Available commands:
        install_wp_cli: Installs WP-CLI."
    valid_commands=("install_wp_cli" "install_wp" "setup_vuln_scanner" "run_scan")

    if [ -z "$1" ]; then
        echo "No command specified."
        echo "${help_msg}"
        exit 1;
    fi

    if [ "$1" == "help" ]; then
        echo "${help_msg}"
        exit 0;
    fi

    # Check for a valid command.
    command_found=false

    for cmd in "${valid_commands[@]}"; do
        if [[ "$cmd" == "$1" ]]; then
            command_found=true
            break
        fi
    done

    if [[ "$command_found" == false ]]; then
        echo "Invalid command specified."
        echo "${help_msg}"
        exit 1
    fi

    # Execute the command passed.
    "$1" "${@:2}"  # Pass additional arguments starting from index 2
}

function install_wp_cli() {
    cd /tmp/wordpress
    curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    chmod +x wp-cli.phar
    sudo mv wp-cli.phar /usr/local/bin/wp
}

function install_wp() {
    cd /tmp/wordpress
    wp config create --dbname=wordpress --dbuser=root --dbpass=root --dbhost=127.0.0.1
    wp core install --url=wpvulnerability.test --title=WordPress --admin_user=progressbar --admin_password=password --admin_email=noreply@dev.null
}

function setup_vuln_scanner() {
    package_install_directory="/tmp/wordpress/wp-content/${type}s/${name}"
    cd /tmp/wordpress
    if [[ ${ type } == "plugin" ]]; then
        wp plugin delete hello
        wp plugin delete akismet
    elif [[ ${ type } == "theme" ]]; then
        rm -rf wp-content/themes/twenty*
    fi
    rm wp-content/db.php
    mkdir -p ${package_install_directory}
    echo "Checking if ${ name } exists in ${package_install_directory}..."
    if [[ -d ${package_install_directory} ]]; then
        echo "✅ Directory exists!"
    else
        echo "❌ Directory does not exist!"
    exit 1
    fi
    echo "$Copying ${ name } from ${GITHUB_WORKSPACE} to ${package_install_directory}"
    cp -r ${GITHUB_WORKSPACE}/${ name }/* ${package_install_directory}
    wp ${ type } list
    wp ${ type } activate "${ name }"
    wp package install 10up/wpcli-vulnerability-scanner:dev-trunk
    wp config set VULN_API_PROVIDER ${ api-provider }
    wp config set VULN_API_TOKEN "${ api-token }"
}

function run_scan() {
    package_name=$(basename "${ workspace }")
    cd /tmp/wordpress
    wp vuln ${ type }-status
    if [[ $(wp vuln ${ type }-status) =~ "No vulnerabilities reported for this version of ${ name }" ]]; then
        echo "✨ No vulnerabilities found"
        exit 0
    else
        echo "❌ Vulnerabilities found"
        exit 1
    fi
}

main "$@"